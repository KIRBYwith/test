<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë„ì„œ ëª©ë¡ - KIRBY ë„ì„œê´€</title>
    <link rel="stylesheet" href="/css/style.css?v=20250118borrow">
    <script src="/js/numberFormatter.js?v=20250118update"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #ffeef5, #fff8e1, #f3e5f5);
            margin: 0;
            padding: 0;
        }
        header {
            background: linear-gradient(135deg, rgba(255, 179, 217, 0.9), rgba(255, 235, 179, 0.9)) !important;
            backdrop-filter: blur(20px) !important;
            box-shadow: 0 8px 32px rgba(255, 179, 217, 0.3) !important;
            padding: 1.5rem 0 !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 1000 !important;
            border-bottom: 3px solid rgba(255, 179, 217, 0.3) !important;
        }
        nav a {
            margin: 0 1rem;
            text-decoration: none;
            color: #d63384;
            font-weight: bold;
        }
        .main-container {
            max-width: 1100px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .page-title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #d63384;
            margin-bottom: 2rem;
        }
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .filters select, .filters input {
            padding: 0.6rem;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
        }
        .book-item {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .book-item img {
            width: 120px;
            height: 160px;
            object-fit: cover;
            margin-bottom: 1rem;
            border-radius: 6px;
            background: #f0f0f0;
        }
        .book-item h3 {
            font-size: 1rem;
            margin: 0.3rem 0;
            color: #d63384;
            text-align: center;
        }
        .book-item p {
            font-size: 0.85rem;
            margin: 0.2rem 0;
            text-align: center;
        }
        .book-item button {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .borrow-btn {
            background: #ff69b4;
            color: #fff;
        }
        .disabled-btn {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
        }
        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
<header>
    <h1><a href="index.html" class="logo-link">ğŸ“–KIRBY ë„ì„œê´€ğŸ“–</a></h1>
    <nav>
        <a href="index.html">í™ˆ</a>
        <a href="login.html" id="loginBtn">ë¡œê·¸ì¸</a>
        <a href="signup.html" id="signupBtn">íšŒì›ê°€ì…</a>
        <a href="books.html">ë„ì„œëª©ë¡</a>
        <a href="board.html">ê²Œì‹œíŒ</a>
        <a href="mypage.html" id="mypageBtn" style="display:none;">ë§ˆì´í˜ì´ì§€</a>
        <a href="admin.html" id="adminBtn" style="display:none; background-color: #ff6b6b; color: white; padding: 5px 10px; border-radius: 5px;">ê´€ë¦¬ìí˜ì´ì§€</a>
    </nav>
</header>

<div class="main-container">
    <h2 class="page-title">ğŸ“š ë„ì„œ ëª©ë¡</h2>

    <div class="filters">
        <select id="categoryFilter">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            <option value="ì² í•™">ì² í•™</option>
            <option value="ì¢…êµ">ì¢…êµ</option>
            <option value="ì‚¬íšŒê³¼í•™">ì‚¬íšŒê³¼í•™</option>
            <option value="ìˆœìˆ˜ê³¼í•™">ìˆœìˆ˜ê³¼í•™</option>
            <option value="ê¸°ìˆ ê³¼í•™">ê¸°ìˆ ê³¼í•™</option>
            <option value="ì˜ˆìˆ ">ì˜ˆìˆ </option>
            <option value="ì–´í•™">ì–´í•™</option>
            <option value="ë¬¸í•™">ë¬¸í•™</option>
            <option value="ì—­ì‚¬">ì—­ì‚¬</option>
        </select>
        <input type="text" id="searchInput" placeholder="ì±… ì œëª© ë˜ëŠ” ì €ì ê²€ìƒ‰">
    </div>

    <div class="book-list" id="bookList"></div>
</div>

<script>
    // state helper
    const s = document.createElement('script');
    s.src = '/js/state.js';
    document.head.appendChild(s);

    // ë¡œê·¸ì¸ ìƒíƒœ ê´€ë¦¬
    document.addEventListener('DOMContentLoaded', function () {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const user = JSON.parse(localStorage.getItem('user') || 'null');

        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const mypageBtn = document.getElementById('mypageBtn');
        const adminBtn = document.getElementById('adminBtn');

        if (isLoggedIn && user) {
            // ë¡œê·¸ì¸ ìƒíƒœë©´ ë¡œê·¸ì¸ â†’ ë¡œê·¸ì•„ì›ƒìœ¼ë¡œ ë°”ê¿ˆ
            loginBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
            loginBtn.href = '#';
            loginBtn.addEventListener('click', function (e) {
                e.preventDefault();
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('user');
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.reload();
            });

            // íšŒì›ê°€ì… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (signupBtn) signupBtn.style.display = 'none';

            // ë§ˆì´í˜ì´ì§€ ë²„íŠ¼ ë³´ì´ê¸°
            if (mypageBtn) mypageBtn.style.display = 'inline-block';

            // ê´€ë¦¬ì ê³„ì •ì¸ ê²½ìš° ê´€ë¦¬ìí˜ì´ì§€ ë²„íŠ¼ ë³´ì´ê¸°
            if (user.role === 'ADMIN') {
                if (adminBtn) adminBtn.style.display = 'inline-block';
            }
        } else {
            // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì¸ ë²„íŠ¼ì„ login.htmlë¡œ ì—°ê²°
            if (loginBtn) {
                loginBtn.href = 'login.html';
            }
            
            // ë§ˆì´í˜ì´ì§€, ê´€ë¦¬ìí˜ì´ì§€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (mypageBtn) mypageBtn.style.display = 'none';
            if (adminBtn) adminBtn.style.display = 'none';
        }
    });

    // CSV ë°ì´í„° â†’ JS ë°°ì—´
    const books = [
        { id:1, title:"ë‹¬ì½¤í•œ ë‚˜ì˜ ë„ì‹œ", author:"ì •ì´í˜„", publisher:"ë¬¸í•™ê³¼ ì§€ì„±ì‚¬", year:"2007", code:"813.6 ì •398ã„·" },
        { id:2, title:"1ë¦¬í„°ì˜ ëˆˆë¬¼", author:"í‚¤í† ì•„ì•¼", publisher:"ì´ë´ìŠ¬ë¦¬ë²¨", year:"2011", code:"836 í‚¤673ã…‡" },
        { id:3, title:"ì²­ì†Œë¶€ ë°¥", author:"í™‰í‚¨ìŠ¤, í† ë“œ", publisher:"ìœ„ì¦ˆë¤í•˜ìš°ìŠ¤", year:"2010", code:"325.04 í† 622ã…Š" },
        { id:4, title:"ë§ˆì‹œë©œë¡œ ì´ì•¼ê¸°", author:"í¬ì‚¬ë‹¤, í˜¸ì•„í‚´ ë°", publisher:"í•œêµ­ê²½ì œì‹ ë¬¸", year:"2010", code:"325.04 í˜¸397ã…" },
        { id:6, title:"í€´ì¦ˆ ì‡¼", author:"ê¹€ì˜í•˜", publisher:"ë¬¸í•™ë™ë„¤", year:"2008", code:"813.6 ê¹€687ã…‹" },
        { id:20, title:"ì¬ë¯¸ìˆëŠ” ì˜ì–‘ì´ì•¼ê¸°", author:"ê¹€í˜„ìˆ™", publisher:"êµë¬¸ì‚¬", year:"2009", code:"594.1 ê¹€953ã…ˆ" },
        { id:30, title:"ì¼ë³¸. 1 : ë– ë‚˜ê¸° ì „ì—", author:"ì‹¬ì²­ë³´", publisher:"ì‚¼ì„±ì¶œíŒì‚¬", year:"2011", code:"981.302 ì‹¬956ã…‡" }
        // ğŸ‘‰ ì‹¤ì œë¡œëŠ” ë„¤ CSV ì „ì²´ ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë„£ìœ¼ë©´ ë¨
    ];

    // ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í•¨ìˆ˜
    function getCategory(code) {
        const num = parseInt(code);
        if (num >= 900) return "ì—­ì‚¬";
        if (num >= 800) return "ë¬¸í•™";
        if (num >= 700) return "ì–´í•™";
        if (num >= 600) return "ì˜ˆìˆ ";
        if (num >= 500) return "ê¸°ìˆ ê³¼í•™";
        if (num >= 400) return "ìˆœìˆ˜ê³¼í•™";
        if (num >= 300) return "ì‚¬íšŒê³¼í•™";
        if (num >= 200) return "ì¢…êµ";
        if (num >= 100) return "ì² í•™";
        return "ê¸°íƒ€";
    }

    // ìƒíƒœ ë³´ì „: ì €ì¥ì†Œ ê¸°ì¤€ìœ¼ë¡œ ìƒíƒœ ê²°ì •
    books.forEach(book => {
        book.category = getCategory(book.code);
    });

    const bookList = document.getElementById('bookList');
    const categoryFilter = document.getElementById('categoryFilter');
    const searchInput = document.getElementById('searchInput');

    function renderBooks() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const state = (window.State && State.getBookState()) || {};
        const category = categoryFilter.value;
        const search = searchInput.value.toLowerCase();
        bookList.innerHTML = '';

        books.filter(b =>
            (category === "" || b.category === category) &&
            (b.title.toLowerCase().includes(search) || b.author.toLowerCase().includes(search))
        ).forEach(book => {
            const div = document.createElement('div');
            div.className = "book-item";

            const status = (state[book.id]?.status) || 'ëŒ€ì¶œê°€ëŠ¥';

            div.innerHTML = `
                <img src="../img/${book.id}.jpg" alt="${book.title}">
                <h3>${book.title}</h3>
                <p>ì €ì: ${book.author}</p>
                <p>ì¶œíŒì‚¬: ${book.publisher} (${book.year})</p>
                <p>ì¹´í…Œê³ ë¦¬: ${book.category}</p>
                <p>ìƒíƒœ: ${status}</p>
            `;

            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'button-group';

            if (status === "ëŒ€ì¶œê°€ëŠ¥") {
                const btn = document.createElement('button');
                btn.className = "borrow-btn";
                btn.textContent = "ëŒ€ì¶œí•˜ê¸°";
                btn.addEventListener('click', () => {
                    if (!isLoggedIn) {
                        alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                        return;
                    }
                    // ëŒ€ì¶œ ì²˜ë¦¬
                    const u = JSON.parse(localStorage.getItem('user'));
                    const st = State.getBookState();
                    if ((st[book.id]?.status) === 'ëŒ€ì¶œì¤‘') {
                        alert('ì´ë¯¸ ëŒ€ì¶œì¤‘ì¸ ë„ì„œì…ë‹ˆë‹¤.');
                        renderBooks();
                        return;
                    }
                    State.setBookLoan(book.id, u.email);
                    u.loans = Array.from(new Set([...(u.loans||[]), book.id]));
                    localStorage.setItem('user', JSON.stringify(u));
                    State.awardPoints(u, 10);
                    alert('ëŒ€ì¶œ ì™„ë£Œ! (+10í¬ì¸íŠ¸)');
                    renderBooks();
                });
                buttonGroup.appendChild(btn);
            } else {
                // ëŒ€ì¶œì¤‘ ìƒíƒœ: ëŒ€ì¶œí•˜ê¸° ë²„íŠ¼ì„ ë¹„í™œì„±í™”ë¡œ í‘œì‹œ
                const disabled = document.createElement('button');
                disabled.className = "disabled-btn";
                disabled.textContent = "ëŒ€ì¶œí•˜ê¸°";
                disabled.disabled = true;
                buttonGroup.appendChild(disabled);

                // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ ì¶”ê°€
                const reserveBtn = document.createElement('button');
                reserveBtn.className = "borrow-btn";
                reserveBtn.textContent = "ì˜ˆì•½í•˜ê¸°";
                reserveBtn.addEventListener('click', () => {
                    if (!isLoggedIn) {
                        alert('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }
                    // ì˜ˆì•½ ì²˜ë¦¬
                    const u = JSON.parse(localStorage.getItem('user'));
                    const st = State.getBookState();

                    // ì´ë¯¸ ì˜ˆì•½í–ˆëŠ”ì§€ í™•ì¸
                    const reservations = st[book.id]?.reservations || [];
                    if (reservations.includes(u.email)) {
                        alert('ì´ë¯¸ ì˜ˆì•½í•˜ì‹  ë„ì„œì…ë‹ˆë‹¤.');
                        return;
                    }

                    // ì˜ˆì•½ ì¶”ê°€
                    State.addReservation(book.id, u.email);
                    u.reservations = Array.from(new Set([...(u.reservations||[]), book.id]));
                    localStorage.setItem('user', JSON.stringify(u));

                    alert('ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    renderBooks();
                });
                buttonGroup.appendChild(reserveBtn);
            }

            div.appendChild(buttonGroup);
            bookList.appendChild(div);
        });
    }

    categoryFilter.addEventListener('change', renderBooks);
    searchInput.addEventListener('input', renderBooks);

    // ì´ˆê¸° ë³´ì •: ì±… ìƒíƒœ ì—”íŠ¸ë¦¬ ìƒì„±
    (function init() {
        if (window.State) {
            State.ensureBookState(books.map(b=>b.id));
        }
        renderBooks();
    })();
</script>
</body>
</html>